<!DOCTYPE html>
<html>
<head>
<title>Cube</title>
</head>
<body>

<svg id="canvas"
    onload="fitToScreen()"
    onresize="fitToScreen()"
>
    <rect id="background"
        x="0" y="0" width="1" height="1"
        fill="white"
        onclick="backgroundClick(event)"
    >
    </rect>
    <text x="20" y="60" font-size="50">Cube</text>
</svg>

<script>
    const CUBE_FILL_NORMAL = 'blue';
    const CUBE_FILL_DAMAGED = 'red';
    const CUBE_START_SIZE = 20;
    const CUBE_MAX_SIZE = 60;
    const CUBE_THINK_INTERVAL_MS = 100;
    const CUBE_MOVE_DISTANCE = 10;

    var nextCubeID = 0;
    const cubes = [];

    function fitToScreen() {
        // There is a 10 pixel border around the screen
        const width = window.innerWidth - 20;
        const height = window.innerHeight - 20;

        const canvas = document.getElementById('canvas');
        canvas.setAttribute('width', width);
        canvas.setAttribute('height', height);

        const background = document.getElementById('background');
        background.setAttribute('width', width);
        background.setAttribute('height', height);
    }

    function backgroundClick(event) {
        const clickX = event.offsetX;
        const clickY = event.offsetY;
        spawnCube(clickX, clickY)
    }

    function spawnCube(x, y) {
        const cube = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
        nextCubeID++;
        cube.setAttributeNS(null, 'id', nextCubeID);
        cube.setAttributeNS(null, 'x', x - CUBE_START_SIZE / 2);
        cube.setAttributeNS(null, 'y', y - CUBE_START_SIZE / 2);
        cube.setAttributeNS(null, 'width', CUBE_START_SIZE);
        cube.setAttributeNS(null, 'height', CUBE_START_SIZE);
        cube.setAttributeNS(null, 'fill', CUBE_FILL_NORMAL);
        cube.setAttributeNS(null, 'onclick', 'cubeClick(event)');
        document.getElementById("canvas").appendChild(cube);
        cubes.push(cube);
        giveLife(cube);
    }

    function cubeClick(event) {
        takeDamage(event.target);
    }

    function takeDamage(cube) {
        cube.setAttribute('fill', 'red');
    }

    async function giveLife(cube) {
        while (true) {
            doSomething(cube);
            await sleep(CUBE_THINK_INTERVAL_MS);
        }
    }

    function sleep(ms) {
        return new Promise(resolve => setTimeout(resolve, ms));
    }

    function doSomething(cube) {
        if (damaged(cube)) {
            recover(cube);
            return;
        }
        const choice = randomNumberBetween(0, 13)
        if (choice === 0) {
            move(cube, 'left')
        } else if (choice === 1) {
            move(cube, 'right')
        } else if (choice === 2) {
            move(cube, 'up')
        } else if (choice === 3) {
            move(cube, 'down')
        } else if (choice === 4) {
            grow(cube, 'fat')
        } else if (choice === 5) {
            grow(cube, 'tall')
        } else {
            // Do nothing
        }
    }

    function damaged(cube) {
        return (cube.getAttribute('fill') === CUBE_FILL_DAMAGED);
    }

    function recover(cube) {
        cube.setAttribute('fill', CUBE_FILL_NORMAL);
    }

    function randomNumberBetween(min, max) {
        return Math.floor(Math.random() * max) + min;
    }

    function move(cube, direction) {
        currX = Number(cube.getAttribute('x'));
        currY = Number(cube.getAttribute('y'));

        if (direction === 'left') {
            cube.setAttribute('x', currX - CUBE_MOVE_DISTANCE);
        } else if (direction === 'right') {
            cube.setAttribute('x', currX + CUBE_MOVE_DISTANCE);
        } else if (direction === 'up') {
            cube.setAttribute('y', currY - CUBE_MOVE_DISTANCE);
        } else if (direction === 'down') {
            cube.setAttribute('y', currY + CUBE_MOVE_DISTANCE);
        }

        if (checkCollision(cube)) {
            takeDamage(cube);
        }
    }

    function checkCollision(cube) {
        const cubeID = cube.getAttribute('id');
        const cubeLeft = Number(cube.getAttribute('x'));
        const cubeRight = cubeLeft + Number(cube.getAttribute('width'));
        const cubeTop = Number(cube.getAttribute('y'));
        const cubeBottom = cubeTop + Number(cube.getAttribute('height'));
        var collision = false;
        cubes.forEach(otherCube => {
            const otherCubeID = otherCube.getAttribute('id');
            if (cubeID === otherCubeID) return;
            const otherCubeLeft = Number(otherCube.getAttribute('x'));
            const otherCubeRight = otherCubeLeft + Number(otherCube.getAttribute('width'));
            const otherCubeTop = Number(otherCube.getAttribute('y'));
            const otherCubeBottom = otherCubeTop + Number(otherCube.getAttribute('height'));
            collision = collision || (
                cubeLeft <= otherCubeRight &&
                cubeRight >= otherCubeLeft &&
                cubeTop <= otherCubeBottom &&
                cubeBottom >= otherCubeTop
            );
        });
        return collision;
    }

    function grow(cube, direction) {
        currWidth = Number(cube.getAttribute('width'));
        currHeight = Number(cube.getAttribute('height'));
        if (currWidth >= CUBE_MAX_SIZE || currHeight >= CUBE_MAX_SIZE) return;
        currX = Number(cube.getAttribute('x'));
        currY = Number(cube.getAttribute('y'));

        if (direction === 'fat') {
            growFat(cube, currX, currWidth)
        } else { // direction === 'tall'
            growTall(cube, currY, currHeight)
        }
    }

    function growFat(cube, currX, currWidth) {
        cube.setAttribute('x', currX - 1);
        cube.setAttribute('width', currWidth + 2);
    }

    function growTall(cube, currY, currHeight) {
        cube.setAttribute('y', currY - 1);
        cube.setAttribute('height', currHeight + 2);
    }
</script>

</body>
</html>