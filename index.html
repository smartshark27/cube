<!DOCTYPE html>
<html>
<head>
<title>Cube</title>
</head>
<body>

<svg id="canvas"
    onload="fitCanvasToScreen()"
    onresize="fitCanvasToScreen()"
    onclick="canvasClick(event)"
>
    <text x="20" y="60" font-size="50">Cube</text>
</svg>

<script>
    const THINK_INTERVAL_MS = 200;
    const STEP_DISTANCE = 10;
    const CUBE_SIZE = 40;
    const CUBE_FILL = 'blue';
    var isAlive = false;
    var nextCubeID = 0;
    const cubes = [];

    function fitCanvasToScreen() {
        const canvas = document.getElementById('canvas');
        // If we don't minus 20 here, the canvas does not go right to the edge
        canvas.setAttribute('width', window.innerWidth - 20);
        canvas.setAttribute('height', window.innerHeight - 20);
    }

    function canvasClick(event) {
        // For some reason, if we don't minus 10, clicking on a square is not accurate
        const clickX = event.clientX - 10;
        const clickY = event.clientY - 10;
        var backgroundClicked = true;
        cubes.forEach(cube => {
            const cubeLeft = Number(cube.getAttribute('x'));
            const cubeRight = cubeLeft + Number(cube.getAttribute('width'));
            const cubeTop = Number(cube.getAttribute('y'));
            const cubeBottom = cubeTop + Number(cube.getAttribute('height'));
            const cubeClicked = cubeLeft <= clickX && clickX <= cubeRight && cubeTop <= clickY && clickY <= cubeBottom;
            if (cubeClicked) {
                backgroundClicked = false;
                cubeClick(cube);
            }
        }, false);
        if (backgroundClicked) {
            spawnCube(clickX, clickY);
        }
    }

    function spawnCube(x, y) {
        const cube = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
        nextCubeID++;
        cube.setAttributeNS(null, 'id', 'cube' + nextCubeID.toString());
        cube.setAttributeNS(null, 'x', x - CUBE_SIZE / 2);
        cube.setAttributeNS(null, 'y', y - CUBE_SIZE / 2);
        cube.setAttributeNS(null, 'width', CUBE_SIZE);
        cube.setAttributeNS(null, 'height', CUBE_SIZE);
        cube.setAttributeNS(null, 'fill', CUBE_FILL);
        document.getElementById("canvas").appendChild(cube);
        cubes.push(cube);
        giveLife(cube);
    }

    function cubeClick(cube) {
        takeDamage(cube);
    }

    function takeDamage(cube) {
        cube.setAttribute('fill', 'red');
    }

    async function giveLife(cube) {
        while (true) {
            doSomething(cube);
            await sleep(THINK_INTERVAL_MS);
        }
    }

    function sleep(ms) {
        return new Promise(resolve => setTimeout(resolve, ms));
    }

    function doSomething(cube) {
        if (hurt(cube)) {
            recover(cube);
            return;
        }
        const choice = randomNumberBetween(0, 9)
        if (choice === 0) {
            move(cube, 'left')
        } else if (choice === 1) {
            move(cube, 'right')
        } else if (choice === 2) {
            move(cube, 'up')
        } else if (choice === 3) {
            move(cube, 'down')
        } else {
            // Do nothing
        }
    }

    function hurt(cube) {
        return (cube.getAttribute('fill') === 'red');
    }

    function recover(cube) {
        cube.setAttribute('fill', CUBE_FILL);
    }

    function randomNumberBetween(min, max) {
        return Math.floor(Math.random() * max) + min;
    }

    function move(cube, direction) {
        currX = Number(cube.getAttribute('x'));
        currY = Number(cube.getAttribute('y'));

        if (direction === 'left') {
            cube.setAttribute('x', currX - STEP_DISTANCE);
        } else if (direction === 'right') {
            cube.setAttribute('x', currX + STEP_DISTANCE);
        } else if (direction === 'up') {
            cube.setAttribute('y', currY - STEP_DISTANCE);
        } else if (direction === 'down') {
            cube.setAttribute('y', currY + STEP_DISTANCE);
        }
    }
</script>

</body>
</html>